<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caduc√©e - Agent M√©dical IA</title>
    <style>
        /* CSS COMPLET ET MIS √Ä JOUR */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h1 { text-align: center; color: #2c3e50; margin-top: 0; }
        .tagline { text-align: center; color: #3498db; margin-top: -15px; margin-bottom: 30px; font-weight: 600; }
        textarea { width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; margin-bottom: 20px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; background-color: #3498db; color: white; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        #result-container { margin-top: 30px; }
        .dialogue-box { margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        .question-text { font-weight: 600; margin-bottom: 15px; }
        .answer-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .answer-btn { flex-grow: 1; background-color: #ecf0f1; color: #34495e; border: 1px solid #bdc3c7; }
        .final-recommendation { margin-top: 20px; padding: 20px; border-radius: 8px; border: 3px solid; }
        .severity-b√©nin { border-color: #2ecc71; background-color: #e8f5e9; }
        .severity-mod√©r√©, .severity-consultation-recommand√©e { border-color: #f39c12; background-color: #fff8e1; }
        .severity-urgent, .severity-high { border-color: #e74c3c; background-color: #fbeae8; }
        .doctors-list { margin-top: 20px; }
        .doctor-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .doctor-card a { font-weight: 600; text-decoration: none; color: #3498db; }
        .modal-overlay { /* ... */ }
    </style>
</head>
<body>
    <!-- ... (HTML de base inchang√©) ... -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (toute la logique de base est ici) ...

            function displayFinalRecommendation(recommendation, severity) {
                const finalBox = document.createElement('div');
                // ... (logique des couleurs)
                finalBox.innerHTML = `...`;
                resultContainer.appendChild(finalBox);

                // NOUVELLE LOGIQUE : On ajoute le bouton de g√©olocalisation
                if (['mod√©r√©', 'consultation-recommand√©e', 'urgent', 'high'].includes((severity || '').toLowerCase().replace(/ /g, '-').replace(/√©/g, 'e'))) {
                    const geoButton = document.createElement('button');
                    geoButton.textContent = 'üìç Trouver un m√©decin √† proximit√©';
                    geoButton.style.marginTop = '15px';
                    geoButton.onclick = findDoctors;
                    finalBox.appendChild(geoButton);
                }
            }

            async function findDoctors() {
                if (!navigator.geolocation) {
                    alert("La g√©olocalisation n'est pas support√©e par votre navigateur.");
                    return;
                }
                
                // On affiche un message d'attente
                const geoStatus = document.createElement('p');
                geoStatus.textContent = "Recherche en cours...";
                resultContainer.appendChild(geoStatus);

                navigator.geolocation.getCurrentPosition(async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`${API_BASE_URL}/doctors/nearby`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ latitude, longitude })
                        });
                        if (!response.ok) throw new Error('Erreur du service de recherche.');
                        const doctors = await response.json();
                        geoStatus.remove(); // On retire le message d'attente
                        displayDoctors(doctors);
                    } catch (e) {
                        geoStatus.textContent = `Erreur : ${e.message}`;
                    }
                }, () => {
                    geoStatus.textContent = "Impossible d'obtenir votre position. Veuillez autoriser la g√©olocalisation.";
                });
            }

            function displayDoctors(doctors) {
                const doctorsDiv = document.createElement('div');
                doctorsDiv.className = 'doctors-list';
                let doctorsHtml = '<h4>M√©decins √† proximit√© :</h4>';
                if (doctors.length === 0) {
                    doctorsHtml += "<p>Aucun m√©decin g√©n√©raliste trouv√© dans un rayon de 5km.</p>";
                } else {
                    doctors.forEach(doc => {
                        doctorsHtml += `<div class="doctor-card"><a href="${doc.url}" target="_blank">${doc.name}</a><p>${doc.address}</p><p>Note : ${doc.rating || 'N/A'}</p></div>`;
                    });
                }
                doctorsDiv.innerHTML = doctorsHtml;
                resultContainer.appendChild(doctorsDiv);
            }

            // ... (le reste du script est identique et correct)
        });
    </script>
</body>
</html>
