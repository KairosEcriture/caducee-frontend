<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Caducée</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f9; margin: 0; }
        .dashboard-container { max-width: 900px; margin: 40px auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: #2c3e50; }
        #logout-btn { background-color: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .profile-section, .history-section { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .profile-form .input-group { margin-bottom: 15px; }
        .profile-form label { font-weight: 600; }
        .profile-form input, .profile-form textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-top: 5px; box-sizing: border-box; }
        .consultation-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .consultation-card p { margin: 5px 0; }
        .consultation-card .date { font-size: 0.8em; color: #777; }
        .new-analysis-btn { display: block; width: 100%; text-align: center; background-color: #2ecc71; color: white; padding: 15px; border-radius: 8px; text-decoration: none; font-size: 1.1em; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>Votre Carnet de Santé</h1>
            <button id="logout-btn">Déconnexion</button>
        </header>

        <a href="index.html" class="new-analysis-btn">Lancer une nouvelle analyse</a>

        <section class="profile-section">
            <h2>Mon Profil Médical</h2>
            <form id="profile-form">
                <div class="input-group"><label>Email: <span id="profile-email" style="font-weight: normal;"></span></label></div>
                <div class="input-group"><label for="age">Âge</label><input type="number" id="age"></div>
                <div class="input-group"><label for="sex">Sexe</label><input type="text" id="sex"></div>
                <div class="input-group"><label for="medical-history">Antécédents</label><textarea id="medical-history"></textarea></div>
                <div class="input-group"><label for="allergies">Allergies</label><textarea id="allergies"></textarea></div>
                <button type="submit">Mettre à jour le profil</button>
            </form>
        </section>

        <section class="history-section">
            <h2>Historique des Consultations</h2>
            <div id="history-list"><p>Aucune consultation pour le moment.</p></div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('caducee_access_token');
            if (!token) { window.location.href = 'login.html'; return; }

            const API_BASE_URL = 'https://caducee-api.onrender.com';
            const profileEmail = document.getElementById('profile-email');
            const ageInput = document.getElementById('age');
            const sexInput = document.getElementById('sex');
            const historyInput = document.getElementById('medical-history');
            const allergiesInput = document.getElementById('allergies');
            const historyList = document.getElementById('history-list');
            const profileForm = document.getElementById('profile-form');
            
            async function loadUserData() {
                try {
                    const [userResponse, consultationsResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/users/me`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_BASE_URL}/consultations`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);
                    
                    const user = await userResponse.json();
                    profileEmail.textContent = user.email;
                    ageInput.value = user.age || '';
                    sexInput.value = user.sex || '';
                    historyInput.value = user.medical_history || '';
                    allergiesInput.value = user.allergies || '';

                    const consultations = await consultationsResponse.json();
                    historyList.innerHTML = '';
                    if (consultations.length > 0) {
                        consultations.forEach(c => {
                            const card = document.createElement('div');
                            card.className = 'consultation-card';
                            const date = new Date(c.created_at).toLocaleDateString('fr-FR');
                            card.innerHTML = `<p class="date">Le ${date}</p><p><strong>Symptôme:</strong> ${c.symptom}</p><p><strong>Recommandation:</strong> ${c.final_recommendation}</p><p><strong>Niveau:</strong> ${c.severity_level}</p>`;
                            historyList.appendChild(card);
                        });
                    } else {
                        historyList.innerHTML = '<p>Aucune consultation pour le moment.</p>';
                    }
                } catch (e) { console.error(e); }
            }

            profileForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const updatedData = {
                    age: parseInt(ageInput.value) || null,
                    sex: sexInput.value,
                    medical_history: historyInput.value,
                    allergies: allergiesInput.value
                };
                await fetch(`${API_BASE_URL}/users/me`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                alert('Profil mis à jour !');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('caducee_access_token');
                window.location.href = 'login.html';
            });

            loadUserData();
        });
    </script>
</body>
</html>